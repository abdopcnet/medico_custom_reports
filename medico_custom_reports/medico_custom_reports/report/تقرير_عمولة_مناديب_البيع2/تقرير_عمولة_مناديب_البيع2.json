{
 "add_total_row": 0,
 "add_translate_data": 0,
 "columns": [],
 "creation": "2025-11-22 19:36:30.872861",
 "disabled": 0,
 "docstatus": 0,
 "doctype": "Report",
 "filters": [],
 "idx": 0,
 "is_standard": "Yes",
 "javascript": "",
 "json": "",
 "letter_head": null,
 "modified": "2025-12-04 16:05:02.148330",
 "modified_by": "Administrator",
 "module": "Medico Custom Reports",
 "name": "\u062a\u0642\u0631\u064a\u0631 \u0639\u0645\u0648\u0644\u0629 \u0645\u0646\u0627\u062f\u064a\u0628 \u0627\u0644\u0628\u064a\u06392",
 "owner": "Administrator",
 "prepared_report": 0,
 "query": "WITH invoice_payments AS (\n    SELECT\n        per.reference_name AS invoice_name,\n        SUM(per.allocated_amount) AS total_paid\n    FROM tabPayment Entry pe\n    JOIN tabPayment Entry Reference per ON per.parent = pe.name\n    WHERE pe.docstatus = 1\n      AND per.reference_doctype = 'Sales Invoice'\n    GROUP BY per.reference_name\n),\n\ninvoice_papers AS (\n    SELECT\n        per.reference_name AS invoice_name,\n        SUM(pe.custom_\u0639\u062f\u062f_\u0627\u0648\u0631\u0627\u0642_\u0627\u0644\u0639\u0642\u062f) AS total_contract_papers\n    FROM tabPayment Entry pe\n    JOIN tabPayment Entry Reference per ON per.parent = pe.name\n    WHERE pe.docstatus = 1\n      AND per.reference_doctype = 'Sales Invoice'\n    GROUP BY per.reference_name\n),\n\ninvoice_vat AS (\n    SELECT\n        parent AS invoice_name,\n        SUM(base_tax_amount_after_discount_amount) AS invoice_vat_total\n    FROM tabSales Taxes and Charges\n    WHERE docstatus = 1\n    GROUP BY parent\n),\n\nsales_persons AS (\n    SELECT\n        parent AS invoice_name,\n        sales_person\n    FROM tabSales Team\n    WHERE parenttype = 'Sales Invoice'\n)\n\nSELECT\n    si.name AS sales_invoice,\n    si.company,\n    si.customer,\n    si.posting_date,\n    si.custom_sales_invoice_number AS customer_invoice_reference_no,\n\n    /* \u0627\u0644\u0645\u0628\u0627\u0644\u063a */\n    si.grand_total,\n    (si.grand_total - si.total_taxes_and_charges) AS subtotal_without_vat,\n\n\n    /* \u0627\u0644\u0645\u0628\u0644\u063a \u0627\u0644\u062e\u0627\u0636\u0639 \u0644\u0644\u0639\u0645\u0648\u0644\u0629 */\n/* \u0627\u0644\u0645\u0628\u0644\u063a \u0627\u0644\u062e\u0627\u0636\u0639 \u0644\u0644\u0639\u0645\u0648\u0644\u0629 */\n(\n    (\n        COALESCE(ip.total_paid, 0) -\n        (\n            COALESCE(ip.total_paid, 0) * 0.01 +\n            (\n                (\n                    CASE WHEN si.grand_total BETWEEN 51 AND 250 THEN (si.grand_total - 50) * 0.048 ELSE 0 END +\n                    CASE WHEN si.grand_total BETWEEN 251 AND 500 THEN (si.grand_total - 50) * 0.052 ELSE 0 END +\n                    CASE WHEN si.grand_total BETWEEN 501 AND 1000 THEN (si.grand_total - 50) * 0.056 ELSE 0 END +\n                    CASE WHEN si.grand_total BETWEEN 1001 AND 5000 THEN (si.grand_total - 50) * 0.06 ELSE 0 END +\n                    CASE WHEN si.grand_total BETWEEN 5001 AND 10000 THEN (si.grand_total - 50) * 0.064 ELSE 0 END +\n                    CASE WHEN si.grand_total > 10000 THEN (si.grand_total - 50) * 0.024 ELSE 0 END\n                ) * (CASE WHEN si.grand_total > 0 THEN COALESCE(ip.total_paid, 0) / si.grand_total ELSE 0 END)\n            ) +\n            (COALESCE(ipapers.total_contract_papers, 0) * 3 * 0.90) +\n            ((COALESCE(iv.invoice_vat_total, 0) * 0.20) *\n                (CASE WHEN si.grand_total > 0 THEN COALESCE(ip.total_paid, 0) / si.grand_total ELSE 0 END))\n        )\n    )\n    - COALESCE(iv.invoice_vat_total, 0)\n) AS amount_eligible_for_commission,\n\n\n    /* \u0646\u0633\u0628\u0629 \u0627\u0644\u0639\u0645\u0648\u0644\u0629 \u0645\u0646 Sales Team */\n    COALESCE(st.commission_rate, 0) AS commission_rate,\n\n    /* \u0642\u064a\u0645\u0629 \u0627\u0644\u0639\u0645\u0648\u0644\u0629 */\n(\n    (\n        /* net_amount_paid */\n        COALESCE(ip.total_paid, 0)\n        -\n        (\n            COALESCE(ip.total_paid, 0) * 0.01 +\n            (\n                (\n                    CASE WHEN si.grand_total BETWEEN 51 AND 250 THEN (si.grand_total - 50) * 0.048 ELSE 0 END +\n                    CASE WHEN si.grand_total BETWEEN 251 AND 500 THEN (si.grand_total - 50) * 0.052 ELSE 0 END +\n                    CASE WHEN si.grand_total BETWEEN 501 AND 1000 THEN (si.grand_total - 50) * 0.056 ELSE 0 END +\n                    CASE WHEN si.grand_total BETWEEN 1001 AND 5000 THEN (si.grand_total - 50) * 0.06 ELSE 0 END +\n                    CASE WHEN si.grand_total BETWEEN 5001 AND 10000 THEN (si.grand_total - 50) * 0.064 ELSE 0 END +\n                    CASE WHEN si.grand_total > 10000 THEN (si.grand_total - 50) * 0.024 ELSE 0 END\n                ) * (CASE WHEN si.grand_total > 0 THEN COALESCE(ip.total_paid, 0) / si.grand_total ELSE 0 END)\n            ) +\n            (COALESCE(ipapers.total_contract_papers, 0) * 3 * 0.90) +\n            (\n                (COALESCE(iv.invoice_vat_total, 0) * 0.20) *\n                (CASE WHEN si.grand_total > 0 THEN COALESCE(ip.total_paid, 0) / si.grand_total ELSE 0 END)\n            )\n        )\n        /* \u062e\u0635\u0645 VAT */\n        - COALESCE(iv.invoice_vat_total, 0)\n    )\n    * (COALESCE(st.commission_rate, 0) / 100)\n) AS incentives,\n\n    /* \u0645\u062c\u0645\u0648\u0639 \u0627\u0644\u0623\u0648\u0631\u0627\u0642 \u0645\u0646 \u062c\u0645\u064a\u0639 \u0627\u0644\u062f\u0641\u0639\u0627\u062a */\n    COALESCE(ipapers.total_contract_papers, 0) AS total_papers,\n\n    /* \u0642\u064a\u0645\u0629 \u0627\u0644\u062f\u0645\u063a\u0629 */\n    (COALESCE(ipapers.total_contract_papers, 0) * 3 * 0.90) AS stamp_value,\n\n    /* \u0627\u0644\u0645\u0646\u062f\u0648\u0628 */\n    sp.sales_person,\n\n    /* Net payable \u0627\u0644\u0645\u0639\u062f\u0644 */\n    (\n        COALESCE(ip.total_paid, 0) -\n        (\n            COALESCE(ip.total_paid, 0) * 0.01 +\n            (\n                (\n                    CASE WHEN si.grand_total BETWEEN 51 AND 250 THEN (si.grand_total - 50) * 0.048 ELSE 0 END +\n                    CASE WHEN si.grand_total BETWEEN 251 AND 500 THEN (si.grand_total - 50) * 0.052 ELSE 0 END +\n                    CASE WHEN si.grand_total BETWEEN 501 AND 1000 THEN (si.grand_total - 50) * 0.056 ELSE 0 END +\n                    CASE WHEN si.grand_total BETWEEN 1001 AND 5000 THEN (si.grand_total - 50) * 0.06 ELSE 0 END +\n                    CASE WHEN si.grand_total BETWEEN 5001 AND 10000 THEN (si.grand_total - 50) * 0.064 ELSE 0 END +\n                    CASE WHEN si.grand_total > 10000 THEN (si.grand_total - 50) * 0.024 ELSE 0 END\n                ) * (CASE WHEN si.grand_total > 0 THEN COALESCE(ip.total_paid, 0) / si.grand_total ELSE 0 END)\n            ) +\n            (COALESCE(ipapers.total_contract_papers, 0) * 3 * 0.90) +\n            ((COALESCE(iv.invoice_vat_total, 0) * 0.20) *\n                (CASE WHEN si.grand_total > 0 THEN COALESCE(ip.total_paid, 0) / si.grand_total ELSE 0 END))\n        )\n    ) AS net_amount_paid\n\nFROM tabSales Invoice si\nLEFT JOIN invoice_payments ip ON ip.invoice_name = si.name\nLEFT JOIN invoice_papers ipapers ON ipapers.invoice_name = si.name\nLEFT JOIN invoice_vat iv ON iv.invoice_name = si.name\nLEFT JOIN sales_persons sp ON sp.invoice_name = si.name\n\n/* \u0647\u0646\u0627 \u0627\u0644\u0631\u0628\u0637 \u0627\u0644\u0635\u062d\u064a\u062d \u0644\u0625\u062d\u0636\u0627\u0631 \u0646\u0633\u0628\u0629 \u0627\u0644\u0639\u0645\u0648\u0644\u0629 */\nLEFT JOIN tabSales Team st\n    ON st.parent = si.name\n    AND st.parenttype = 'Sales Invoice'\n\nWHERE si.docstatus = 1;",
 "ref_doctype": "Payment Entry",
 "report_name": "\u062a\u0642\u0631\u064a\u0631 \u0639\u0645\u0648\u0644\u0629 \u0645\u0646\u0627\u062f\u064a\u0628 \u0627\u0644\u0628\u064a\u06392",
 "report_script": "",
 "report_type": "Query Report",
 "roles": [
  {
   "role": "Accounts User"
  },
  {
   "role": "Accounts Manager"
  }
 ],
 "timeout": 0
}